# 트랜잭션(Transaction)

![image-20210227215115362](C:\Users\oh12s\Desktop\면접스터디\SKILL\Oracle\image\image-20210227215115362.png)





DB Transaction(트랜잭션) 이란?

- - 데이터의 무결성으로 인하여 데이터 작업시에 문제가 생기면, 데이터 작업을 하기 이전 시점으로 모든 데이터를 원상 복구 하는 것을 말한다.
  - 즉, 모두 실행되거나 모두 실행되지 않거나를 뜻한다.



### ***\**\*\*\*[ 트랜잭션(Transaction)이란? ]\*\*\*\*\****

하나 이상의 쿼리를 처리할 때 동일한 Connection 객체를 공유하여 에러가 발생한 경우 모든 과정을 되돌리기 위한 방법입니다.



**3. 트랜잭션이란?** 

 

데이터베이스의 상태를 변화시키기 위하여 , 논리적인 기능을 수행하는 하나의 작업단위 또는 한꺼번에 모두 수행되어야 하는 연산들

데이터베이스의 완전성을 보장하기 위한것이 목적

정상적으로 실행되었을 경우에는 commit이 이루어지고, 그렇지 않을 경우에는 rollback이 실행되면서 

데이터베이스에는 아무런 영향을 끼치지 않음 (all or nothing)

 

**트랜잭션의 특성**

- 원자성(Atomicity) : 트랜잭션의 연산은 데이터베이스에 모두 반영되든지 아니면 전혀 반영되지 않아야 함 
- 독립성(Isolation) : 실행중에 있는 연산의 중간 결과에 다른 트랜잭션이 접근할 수 없음
- 일관성(Consistency) : 실행을 성공적으로 완료하면 언제나 일관성있는 데이터베이스 상태로 변환함
- 지속성(Durability) : 일단 실행이 성공적으로 완료 되면 결과는 지속적이어야 함 

\- commit : 정상적으로 처리되어서 트랜잭션이 반영된 상태 

\- rollback : 취소하거나 정상적으로 이루어지지 않을 때 이전 상태로 돌아가는 것





#### Q. 트랜잭션이 뭔가요?

A. 하나의 논리적 기능을 수행하기 위한 작업의 단위로, DB의 일관된 상태를 또 다른 일관된 상태로 변환시키는 기능을 수행한다.

#### Q. 트랜잭션의 성질을 말씀해보세요.

A. ACID라 불리는 총 네가지 성질을 가지고있습니다.

- Atomicity는 트랜잭션의 연산이 DB에 모두 반영되던지 전혀 반영이되지 않던지 둘중에 하나만 수행해야한다.(원자성)
- Consistency는 트랜잭션이 성공적으로 완료된 후에는 언제나 일관성 있는 DB상태로 변환되어야한다.(일관성)
- Isolation은 수행중인 트랜잭션이 완전히 완료되기 전에는 다른 트랙잭션에서 수행 결과를 참조할 수 없다.(독립성)
- Durablility는 성공적으로 완료된 트랜잭션의 결과는 시스템이 고장나더라도 영구적으로 반영되어야 한다.(영속성)

#### Q. 트랜잭션을 병행으로 처리하려고 할 때 발생할 수 있는 문제를 설명해보시오.

A.

- 갱신 내용 손실 : 동시에 하나의 데이터가 갱신될 때 하나의 갱신이 누락되는 경우
- 현황 파악 오류 : 하나의 데이터 갱신이 끝나지 않은 시점에서 다른 트랜잭션이 해당 데이터를 조회하는 경우
- 모순성 : 두 트랜잭션이 동시에 실행될 때 데이터베이스가 일관성이 없는 모순된 상태로 남는 문제
- 연쇄 복귀 : 두 트랜잭션이 하나의 레코드를 갱신할 때 하나의 트랜잭션이 롤백하면 다른 하나의 트랜잭션 마저 롤백이 되는 문제

#### Q. 트랜잭션을 병행으로 처리할 때 위와 같은 문제를 방지하기 위한 방법을 설명하시오.

A. 로킹 제어 기법을 사용한다.

어떤 트랜잭션이 특정 DB의 데이터를 사용할 때 DB의 일정부분을 Lock시키고 트랜잭션이 완료될때 해당부분을 Unlock시키는 방법이다. 종류는 크게 두가지가 있는데 공유 로킹은 Lock한 부분을 읽기는 가능하지만 쓰기는 불가능한 것이고 배타 로킹은 읽기,쓰기 둘다 불가능하게 한 것이다.

#### Q. 그렇다면 이 로킹 단위를 크게했을 때와 작게 했을 때의 차이점을 설명하시오.

A. 로킹 단위가 크면 그만큼 관리가 쉽지만 병행성이 떨어진다. 로킹단위가 작으면 관리가 어렵고 오버헤드가 증가하지만, 병행성이 올라간다.

#### Q. 로킹 제어가 일으킬 수 있는 문제점은 무엇인가?

A. 로킹단위에 따라 다르겠지만 트랜잭션의 직렬화 가능성이 높아진다.(병행처리하나마나 할 수도있다.) 또 데드락이 발생할 수 있다.

#### Q. 데드락에 대해서 설명해보세요.

T1 : write(A) read(B)

T2 : read(B) read(A)

위와 같은 트랜잭션이 있다고 하면 T1은 A를 로킹해두고 B의 로킹해제를 기다려야하고 T2는 B를 로킹해두고 A를 기다려야한다. 이 때 두 트랜잭션이 무한정 대기해야하는 상황이 발생하는데 이것을 데드락이라고 한다. (해결방법 : 이 경우 T1, T2중 하나를 ROLLBACK하고 나머지 하나를 완료시킨 후 ROLLBACK한 트랜잭션을 다시 실행시킨다.)

#### Q. 그럼 데드락을 안 생기게 하는 방법을 설명해보시오.

A.

서비스 별로 해결하는 방법이 매우 다른데 일반적으로는 데드락 탐지나 회피를 적용시키면 된다.

탐지인 경우 알고리즘을 통해 매번 데드락인지 아닌지 검사를 해야하므로 코스트가 크다.

회피인 경우 시분할 처리를하여 T1이 끝나면 T2가 실행시키게도 하면된다.

Facebook 처럼 write 보다 read가 월등히 많은 경우 Read용 DB를 slave로 두고 로드를 모두 몰아주고 write를 Master로 보내고 DB를 동기화 할 수도 있다.

또 다른 해결기법으론 로킹 제어기법이 아닌 타임스탬프 기법을 사용한다. 트랜잭션의 식별자로 타임스탬프를 지정하며 순서를 미리 선택한다. 트랜잭션이 대기하지 않고 바로 실행은 하나 높은 확률로 ROLLBACK이 일어나며 연쇄 복귀를 초래할 수 있다.

#### Q. COMMIT과 ROLLBACK에 대해 설명해보세요.

A. COMMIT은 해당 트랜잭션으로 반영된 DB 변경사항을 ***저장\*** 하는 것이고 ROLLBACK은 해당 트랜잭션으로 반영된 DB 변경사항을 ***취소\*** 하는 것이고



**6. 트랜잭션** 

 



![img](https://blog.kakaocdn.net/dn/Yt9vN/btqAQlJkqWT/3KarwdrY3lGkPCfgNZaUb1/img.png)



- 작업의 완전성 보장 
- 논리적 작업 셋이 모두 완벽하게 처리하거나 또는 처리하지 못할 경우 원상태로 복구해서 작업의 일부만 적용되는 현상 발생하지 않게 만들어주는 기능 
- 성질 : ACID(원자성 + 일관성 + 고립성 + 지속성)
- LOCK : 동시성 제어 VS 트랜잭션 : 데이터 정합성 보장 기능 

**7. DeadLock**

- 정의 : 두 개 이상의 트랜잭션이 특정 자원의 잠금(lock)을 획득한 채 다른 트랜잭션이 소유하고 있는 잠금을 요구하면 아무리 기다려도 상황이 바뀌지 않는 상태
- 빈도 낮추는 방법
  - 트랜잭션을 자주 커밋 
  - 정해진 순서로 테이블 접근
  - 읽기 잠금 획득 사용 피함
  - 복수 행의 연결에서 잠금을 획득해 갱신을 직렬화 하면 동시성은 떨어지지만 데드락 회피 가능 
- 데드락 발생 순서 
  - 트랜잭션 1 -> B t 첫번째 행 잠금 획득
  - 트랜잭션 2 => A t 첫번쨰 행 잠금 획득
  - 트랜잭션 commit 하지 않은 채 서로의 첫 번째 행에 대한 잠금 요청 시 데드락 발생



트랜잭션(Transaction) 이란
트랜잭션(Transaction) 이란
데이터베이스의 상태를 변환시키는 하나의 논리적인 작업 단위를 구성하는 연산들의 집합이다.
예를들어, A계좌에서 B계좌로 일정 금액을 이체한다고 가정하자.
A계좌의 잔액을 확인한다.
A계좌의 금액에서 이체할 금액을 빼고 다시 저장한다.
B계좌의 잔액을 확인한다.
B계좌의 금액에서 이체할 금액을 더하고 다시 저장한다.
이러한 과정들이 모두 합쳐져 계좌이체라는 하나의 작업단위를 구성한다.
하나의 트랜잭션은 Commit 되거나 Rollback 된다.
Commit 연산
한개의 논리적 단위(트랜잭션)에 대한 작업이 성공적으로 끝나 데이터베이스가 다시 일관된 상태에 있을 때, 이 트랜잭션이 행한 갱신 연산이 완료된 것을 트랜잭션 관리자에게 알려주는 연산이다.
Rollback 연산
하나의 트랜잭션 처리가 비정상적으로 종료되어 데이터베이스의 일관성을 깨뜨렸을 때, 이 트랜잭션의 일부가 정상적으로 처리되었더라도 트랜잭션의 원자성을 구현하기 위해 이 트랜잭션이 행한 모든 연산을 취소(Undo)하는 연산이다.
Rollback 시에는 해당 트랜잭션을 재시작하거나 폐기한다.
데이터베이스 응용 프로그램은 트랜잭션들의 집합으로 정의 할 수 있다.
트랜잭션의 성질(ACID)
원자성(Atomicity), All or nothing
트랜잭션의 모든 연산들은 정상적으로 수행 완료되거나 아니면 전혀 어떠한 연산도 수행되지 않은 상태를 보장해야 한다.
일관성(Consistency)
트랜잭션 완료 후에도 데이터베이스가 일관된 상태로 유지되어야 한다.
독립성(Isolation)
하나의 트랜잭션이 실행하는 도중에 변경한 데이터는 이 트랜잭션이 완료될 때까지 다른 트랜잭션이 참조하지 못한다.
지속성(Durability)
성공적으로 수행된 트랜잭션은 영원히 반영되어야 한다.
트랜잭션의 필요성
현금 인출기를 작동하는 도중에 기계오류나 정전 등과 같은 예기치 않은 상황이 발생하여 카드가 나오지 않거나 기계가 멈추는 경우
각각 다른 지점의 은행에서 동시에 인출할 때, 하나의 지점이 다른 지점에서 저장한 잔액을 덮어 쓰는 경우
위와 같은 상황이 발생되지 않도록 방지하기 위해, 즉, 트랜잭션의 성질인 ACID를 제공받기위해 트랜잭션을 사용한다.
트랜잭션의 상태



활동(Active)
트랜잭션이 실행 중에 있는 상태, 연산들이 정상적으로 실행 중인 상태
장애(Failed)
트랜잭션이 실행에 오류가 발생하여 중단된 상태
철회(Aborted)
트랜잭션이 비정상적으로 종료되어 Rollback 연산을 수행한 상태
부분 완료(Partially Committed)
트랜잭션이 마지막 연산까지 실행했지만, Commit 연산이 실행되기 직전의 상태
완료(Committed)
트랜잭션이 성공적으로 종료되어 Commit 연산을 실행한 후의 상태
https://gmlwjd9405.github.io/2017/10/01/basic-concepts-of-development-db.html





7. 트랜잭션

\- 데이터베이스의 논리적인 작업단위. 전부 적용하거나 전부 취소. All or Nothing

\- 특성(ACID) : 원자성(atomicity), 일관성(consistency), 고립성(isolation), 지속성(durability)

\- TCL : 트랜잭션 제어어(COMMIT, ROLLBACK, SAVEPOINT)

\- 명시적 트랜잭션 가능 : begin tran, commit or rollback

\- 데이터무결성 보장, 그룹핑하여 작업가능, 작업전 변경사항 확인가능

\- DDL문 실행시 전 후 시점에 자동으로 COMMIT됨

\- 데이터베이스 정상 종료시 자동 COMMIT / 이상 종료시 자동 ROLLBACK